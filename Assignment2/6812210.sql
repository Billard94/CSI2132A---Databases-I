-- CSI2132 Assignment 2
-- Student Name: Alexandre Billard
-- Student Number: 6812210

drop schema "Assignment2" cascade;

create schema "Assignment2";

set search_path = 'Assignment2';

CREATE TABLE REP
(REP_NUM CHAR(2) PRIMARY KEY,
LAST_NAME CHAR(15),
FIRST_NAME CHAR(15),
STREET CHAR(15),
CITY CHAR(15),
STATE CHAR(3),
ZIP CHAR(5),
COMMISSION DECIMAL(7,2),
RATE DECIMAL(3,2) );

CREATE TABLE CUSTOMER
(CUSTOMER_NUM CHAR(3) PRIMARY KEY,
CUSTOMER_NAME CHAR(35) NOT NULL,
STREET CHAR(15),
CITY CHAR(15),
STATE CHAR(3),
ZIP CHAR(5),
BALANCE DECIMAL(8,2),
CREDIT_LIMIT DECIMAL(8,2),
REP_NUM CHAR(2),
-- Question 1a
CONSTRAINT CHECK_BALANCE CHECK (BALANCE > 0 OR BALANCE <= CREDIT_LIMIT));

CREATE TABLE ORDERS
(ORDER_NUM CHAR(5) PRIMARY KEY,
ORDER_DATE DATE,
CUSTOMER_NUM CHAR(3) );

CREATE TABLE PART
(PART_NUM CHAR(4) PRIMARY KEY,
DESCRIPTION CHAR(15),
ON_HAND DECIMAL(4,0),
CLASS CHAR(2),
WAREHOUSE CHAR(1),
PRICE DECIMAL(6,2),
-- Question 1b
CONSTRAINT CHECK_CLASS CHECK (CLASS = 'AP' OR CLASS = 'HW' OR CLASS = 'SG'));

CREATE TABLE ORDER_LINE
(ORDER_NUM CHAR(5),
PART_NUM CHAR(4),
NUM_ORDERED DECIMAL(3,0),
QUOTED_PRICE DECIMAL(6,2),
PRIMARY KEY (ORDER_NUM, PART_NUM),
-- Question 1c
CONSTRAINT CHECK_ORDERLINE CHECK (ORDER_NUM != NULL AND PART_NUM != NULL));

INSERT INTO REP
VALUES
('20','Kaiser','Valerie','624 Randall','Grove','ONT','33321',20542.50,0.05);
INSERT INTO REP
VALUES
('35','Hull','Richard','532 Jackson','Sheldon','ONT','33553',39216.00,0.07);
INSERT INTO REP
VALUES
('65','Perez','Juan','1626 Taylor','Fillmore','ONT','33336',23487.00,0.05);
INSERT INTO CUSTOMER
VALUES
('148','Al''s Appliance and Sport','2837
Greenway','Fillmore','ONT','33336',6550.00,7500.00,'20');
INSERT INTO CUSTOMER
VALUES
('282','Brookings Direct','3827
Devon','Grove','ONT','33321',431.50,10000.00,'35');
INSERT INTO CUSTOMER
VALUES
('356','Ferguson''s','382
Wildwood','Northfield','ONT','33146',5785.00,7500.00,'65');
INSERT INTO CUSTOMER
VALUES
('408','The Everything Shop','1828
Raven','Crystal','ONT','33503',5000.00,5000.00,'35');
INSERT INTO CUSTOMER
VALUES
('689','The Everything Shoppe','181
Black','Ottawa','ONT','33403',5000.00, 3000.00,'20');
INSERT INTO CUSTOMER
VALUES
('461','Bargain Galores','30
West','Ottawa','ONT','33321',35612.00,30000.00,'20');
INSERT INTO CUSTOMER
VALUES
('462','Bargains Galore','3829
Central','Grove','ONT','33321',3412.00,10000.00,'65');
INSERT INTO CUSTOMER
VALUES
('524','Kline''s','838
Ridgeland','Fillmore','ONT','33336',12762.00,15000.00,'20');
INSERT INTO CUSTOMER
VALUES
('608','Johnson''s Department Store','372
Oxford','Sheldon','ONT','33553',2106.00,10000.00,'65');
INSERT INTO CUSTOMER
VALUES
('687','Lee''s Sport and Appliance','282
Evergreen','Altonville','ONT','32543',2851.00,5000.00,'35');
INSERT INTO CUSTOMER
VALUES
('725','Deerfield''s Four Seasons','282
Columbia','Sheldon','ONT','33553',248.00,7500.00,'35');
INSERT INTO CUSTOMER
VALUES
('842','All Season','28 Lakeview','Grove','ONT','33321',7500.00,7500.00,'20');
INSERT INTO ORDERS
VALUES
('21608','2007-10-20','148');
INSERT INTO ORDERS
VALUES
('21610','2007-10-20','356');
INSERT INTO ORDERS
VALUES
('21613','2007-10-21','408');
INSERT INTO ORDERS
VALUES
('21614','2007-10-21','282');
INSERT INTO ORDERS
VALUES
('21617','2007-10-23','608');
INSERT INTO ORDERS
VALUES
('21619','2007-10-23','148');
INSERT INTO ORDERS
VALUES
('21623','2007-10-23','608');
INSERT INTO PART
VALUES
('AT94','Iron',50,'HW','3',24.95);
INSERT INTO PART
VALUES
('BV06','Home Gym',45,'SG','2',794.95);
INSERT INTO PART
VALUES
('CD52','Microwave Oven',32,'AP','1',165.00);
INSERT INTO PART
VALUES
('DL71','Cordless Drill',21,'HW','3',129.95);
INSERT INTO PART
VALUES
('DR93','Gas Range',8,'AP','2',495.00);
INSERT INTO PART
VALUES
('DW11','Washer',12,'AP','3',399.99);
INSERT INTO PART
VALUES
('FD21','Stand Mixer',22,'HW','3',159.95);
INSERT INTO PART
VALUES
('KL62','Dryer',12,'AP','1',349.95);
INSERT INTO PART
VALUES
('KT03','Dishwasher',8,'AP','3',595.00);
INSERT INTO PART
VALUES
('KV29','Treadmill',9,'SG','2',1390.00);
INSERT INTO ORDER_LINE
VALUES
('21608','AT94',11,21.95);
INSERT INTO ORDER_LINE
VALUES
('21610','DR93',1,495.00);
INSERT INTO ORDER_LINE
VALUES
('21610','DW11',1,399.99);
INSERT INTO ORDER_LINE
VALUES
('21613','KL62',4,329.95);
INSERT INTO ORDER_LINE
VALUES
('21614','KT03',2,595.00);
INSERT INTO ORDER_LINE
VALUES
('21617','BV06',2,794.95);
INSERT INTO ORDER_LINE
VALUES
('21617','CD52',4,150.00);
INSERT INTO ORDER_LINE
VALUES
('21619','DR93',1,495.00);
INSERT INTO ORDER_LINE
VALUES
('21623','KV29',2,1290.00);

-- Question 2
select C.CUSTOMER_NUM, C.CUSTOMER_NAME
from CUSTOMER C
where C.REP_NUM !='20';

-- Question 3
select R.FIRST_NAME, R.LAST_NAME, COUNT(*) as AMOUNT_REP
from CUSTOMER C, REP R
where R.REP_NUM = C.REP_NUM
group by R.FIRST_NAME, R.LAST_NAME;

-- Question 4
select distinct C1.CUSTOMER_NUM, C1.CUSTOMER_NAME, C1.BALANCE, C1.REP_NUM
from CUSTOMER C1
where C1.BALANCE > (select MIN(C2.BALANCE)
			             from CUSTOMER C2, REP R2
			             where R2.REP_NUM = C2.REP_NUM
					              and R2.LAST_NAME = 'Perez');

-- Question 5
select distinct O.ORDER_NUM, O.ORDER_DATE
from ORDERS O, REP R, ORDER_LINE L, PART P
where P.DESCRIPTION = 'Gas Range'
	    and P.PART_NUM = L.PART_NUM
            and L.ORDER_NUM = O.ORDER_NUM
	    and R.REP_NUM = '65';

-- Question 6
select C1.CUSTOMER_NUM, C1.CUSTOMER_NAME, C1.BALANCE
from CUSTOMER C1
where C1.CREDIT_LIMIT = (select MAX(C2.CREDIT_LIMIT)
                         from CUSTOMER C2
                         where C2.REP_NUM = '35');

-- Question 7
select distinct R.REP_NUM, R.FIRST_NAME, R.LAST_NAME, SUM(case when P.CLASS = 'AP' then 1 else null end) as AMOUNT_AP
from REP R, CUSTOMER C, PART P, ORDERS O, ORDER_LINE L
where P.CLASS = 'AP' and P.PART_NUM = L.PART_NUM
	                   and L.ORDER_NUM = O.ORDER_NUM
	                   and O.CUSTOMER_NUM = C.CUSTOMER_NUM
	                   and C.REP_NUM = R.REP_NUM
	                   group by R.REP_NUM, R.FIRST_NAME, R.LAST_NAME;

-- Question 8
select TEMP.CREDIT_LIMIT, COUNT (case when TEMP.CREDIT_LIMIT = C.CREDIT_LIMIT then 1 else null end) as AMOUNT_CUST
from ( select C2.CREDIT_LIMIT, COUNT (*) as AMOUNT_CUST
	     from CUSTOMER C2
	     group by C2.CREDIT_LIMIT ) as TEMP, CUSTOMER C, REP R
where TEMP.AMOUNT_CUST < 2 and C.REP_NUM = '35'
group by TEMP.CREDIT_LIMIT;

-- Question 9
select P.DESCRIPTION, L.ORDER_NUM
from PART P NATURAL LEFT OUTER JOIN ORDER_LINE L
where L.ORDER_NUM = '21610';

-- Question 10
select distinct C.CUSTOMER_NUM, C.CUSTOMER_NAME, C.BALANCE, C.REP_NUM
from CUSTOMER C, REP R
where (C.REP_NUM = R.REP_NUM
	     AND C.BALANCE < (C.CREDIT_LIMIT*0.15));

-- Question 11
select distinct C.CUSTOMER_NUM, C.CUSTOMER_NAME, C.BALANCE
from CUSTOMER C, ORDERS O
where (C.REP_NUM = '20'
	     AND C.CUSTOMER_NUM != O.CUSTOMER_NUM);

-- Question 12
delete from CUSTOMER
where CUSTOMER_NUM = '408';
